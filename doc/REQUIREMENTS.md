# パスワードマネージャ仕様

## 機能概要
個人向けパスワードマネージャとしての基本機能を持つ。CLIとして実装され以下のサブコマンドを実装する。
登録されたエントリはデータベースに保存される。データベースはredbにより構築される。

----
## エントリの仕様
エントリのデータ構造をYAML形式のJSON Schemaで記述する。

```YAML
type: "object"
required:
  - id
  - aliases
  - tags
  - properties
properties:
  id:
    description: >-
      エントリのIDが文字列形式のULIDで格納される
    type: "string"

  service:
    description: >-
      エントリのサービス名が格納される。
    type: "string"
  
  aliases:
    description: >-
      エントリの別名(サービスの旧名など)のリストが格納される。
    type: "array"
    items: "string"
    minItems: 0

  tags:
    description: >-
      エントリに付与されたタグ文字列のリストが格納される
    type: "array"
    items: "string"
    minItems: 0

  properties:
    description: >-
      ユーザ名やパスワードなどエントリのプロパティ情報が格納される。プロパティ名
      の末尾に'!'を付与した場合、秘匿項目として扱われる。
    type: "object"
    minItems: 1
```

----
## コマンドライン仕様
```sh
pwmgr [OPTIONS] <SUB-COMMAND> [COMMAND-OPTIONS]
```

### グローバルオプション
グローバルオプションとして以下の物を指定できる。

| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-c`, `--config PATH`   | デフォルト設定ファイルのパスを指定する | %LOCALAPPDATA%\pwmgr\config.toml (windows)<br>~/.config/pwmgr/config.toml (linux, macos)
| `-d`, `--db-path PATH`  | データベースファイルのパスを設定する   | %LOCALAPPDATA%\pwmgr\database.redb (windows)<br>~/.local/share/pwmgr/database.redb (linux, macos)
| `-e`, `--editor EDITOR` | 編集で使用するテキストエディタの名前を指定する | notepad (windows)<br>nano (linux, macos)
| `--json-output`         | 出力をJSON形式にする
| `--show-option`         | 設定内容(オプションの指定内容)を表示する
| `--save-default`        | config.tomlへのデフォルト値の書き込み指示
| `-h`, `--help`          | ヘルプメッセージの表示
| `-v`, `--version`       | プログラムのバージョン番号の表示

`--db-path`および`--editor`についてはconfig.tomlでデフォルト値を設定することができる。
また`--editor`については環境変数EDITORでも設定することができる。設定の優先度は コマンドラインオプション &gt; config.toml &gt; 環境変数となる。

----
### サブコマンド
以下のサブコマンドが使用できる。

  - query : エントリの表示 
  - search : サービスの検索
  - add : エントリの追加
  - edit : エントリの編集
  - list : 既存エントリの一覧表示
  - tags : 付与済みタグの一覧表示
  - export : バックアップ用YAMLの出力
  - import : バックアップ用YAMLの取り込み

#### queryコマンド
エントリの検索・表示(一件のみ)。

##### コマンドライン
```sh
pwmgr [OPTIONS] query [COMMAND-OPTIONS] <KEY>
```
##### オプション
queryコマンドのオプションは以下の物が指定できる。

| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-f`, `--full` | 全ての項目を表示する    | 
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact
| `-h`, `--help` | ヘルプメッセージの表示  |

##### 概要
引数KEYでサービスを検索し、該当するエントリの情報を標準出力に表示する。KEYは以下の項目を検索対象とする(番号は検索優先度)。

 1. エントリのID (完全一致)
 2. サービス名 (あいまい検索)
 3. 別名リスト (あいまい検索)

`--match-mode`でマッチモードを選択することができる。設定できるモードは以下の通り。

 - exact : 完全一致モード(但し大文字小文字は無視)
 - contains : 部分一致モード(大文字小文字は無視)
 - regex : 正規表現モード
 - fuzzy : 揺らぎモード

通常は以下の項目のみを表示する。

 - ID
 - サービス名
 - 全てのプロパティ(秘匿処理は行わない)

オプション`--full`が指定された場合はエントリとして定義されている全ての項目を表示する。
表示対象は最初に見つかった一件のみを出力する。

----
#### searchコマンド

##### コマンドライン
```sh
pwmgr search [OPTIONS] <KEY>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-s`, `--service`   | サービス名を検索対象とするか否かを表すフラグ | 
| `-t`, `--tag <TAG>` | 検索対象とするタグ(複数指定可) | 
| `-p`, `--property <PROPERTY_NAME>` | 検索対象とするプロパティ(複数指定可) | 
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
引数KEYでサービスを検索しIDとサービス名のリストを標準出力に表示する。queryと異なり複数のエントリをリストアップする。`--property`オプションが指定されない場合は、サービス名と別名リストを検索の対象とする。

`--tag`オプションでタグを指定したときは、そのタグが付与されたエントリのみを検索対象として絞り込む。

`--property`オプションでプロパティ名を指定したときは、そのプロパティを検索対象とする(例えば特定の住所で登録されたエントリの検索などを想定)。

`--regex`オプションが指定された場合はKEYを正規表現と見なし、正規表現にマッチするエントリの検索を行う。

----
#### addコマンド

##### コマンドライン
```sh
pwmgr add [OPTIONS]

```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
エントリの新規登録を行う。本コマンドが実行されると、エディタの起動を行いYAM形式のテンプレートをユーザに編集させる。

エディタで書き込み保存され、入力された内容がスキーマに一致する場合はその内容でエントリの登録を行う。

エディタで入力が行われなかった場合や、スキーマに一致しない内容だった場合はユーザに継続して編集するか否かを問いあわせ細雨編集を行うか否かを決定する(このとき内容をリセットするか否かも選択肢に入れる)。

編集用のテンプレートはエントリ定義用のYAMLのスケルトンを用いる。但し、サービスIDは事前に割り当てるので入力済みとする。

----
#### editコマンド

##### コマンドライン
```sh
pwmgr edit [OPTIONS] <ID>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
引数IDでサービスを検索し、該当するエントリの編集を行う。

エディタで書き込み保存され、入力された内容がスキーマに一致する場合はその内容でエントリの上書を行う。このとき、入力内容の表示を行い上書の確認を行う。

エディタで入力が行われなかった場合や、スキーマに一致しない内容だった場合はユーザに継続して編集するか否かを問いあわせ再編集を行うか否かを決定する(このとき内容をリセットするか否かも選択肢に入れる)。

----
#### listコマンド

##### コマンドライン
```sh
pwmgr list [OPTIONS]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-t`, `--tag <TAG>` | リストアップ対象タグ(複数指定可) |
| `-N`, `--sort-by-service-name` | エントリの表示順をサービス名でソートする |
| `-r`, `--reverse-sort` | ソートを逆順で行う | 
| `-h`, `--help`      | ヘルプメッセージの表示  |


##### 概要
登録されているサービスの一覧を標準出力に出力する。出力はIDとサービス名の組をリスティングする(ID順で出力する)。`--tag`が指定されていない場合は登録されているエントリ全てがリスティング対象となる。

`--tag`でタグ名が指定された場合は、そのタグの一覧を出力する。複数`--tag`オプションが指定された場合は指定されたタグ全てが出力対象となる。

----
#### tagsコマンド

##### コマンドライン
```sh
pwmgr tags [OPTIONS] [KEY]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact 
| `-n`, `--number`  | 登録件数表示モード | 
| `-s`, `--sort-by-number` | 登録件数によるソート | 
| `-r`, `--reverse-sort` | ソートを逆順で行う | 
| `-h`, `--help`    | ヘルプメッセージの表示  |


##### 概要
付与されているタグの一覧を表示する。`KEY`を指定した場合はキーワードに基づいた絞り込みを行う。オプションが何も指定されない場合はタグを文字列を昇順にソートして表示する。

`--match-mode`でマッチモードを選択することができる。設定できるモードは以下の通り。

 - exact : 完全一致モード(但し大文字小文字は無視)
 - contains : 部分一致モード(大文字小文字は無視)
 - regex : 正規表現モード
 - fuzzy : 揺らぎモード

`--number`でタグ毎の登録件数の表示を行う事ができる。

`--sort-by-number`を指定すると表示順序を件数順でソートするようになる(標準は降順でソート)。

タグが全く登録されていない場合は「付与されたタグはありません」と表示しエラーとして扱う。

----
#### exportコマンド

##### コマンドライン
```sh
pwmgr export [OPTIONS]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-o`, `--output <PATH>` | 出力先のファイルのパス | 
| `-h`, `--help`          | ヘルプメッセージの表示  |

##### 概要
バックアップ若しくはデータ移行用のYAMLファイルを出力する。`--output`オプションが指定されていない場合は標準出力へ出力する。現バージョンでは平文による出力を行う。

`--output`オプションが指定されている場合、オプションで指定されたファイルへの出力を行う。

----
#### importコマンド

##### コマンドライン
```sh
pwmgr import [OPTIONS] [INPUT]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-m`, `--merge`        | マージを行うか否かのフラグ | 
| `-O`, `--overwrite`    | オーバーライトを行うか否かのフラグ |
| `--dry-run`            | Dru-Runフラグ | 
| `-h`, `--help`          | ヘルプメッセージの表示  |

##### 概要
`export`サブコマンドで出力されたYAMLファイルの取り込みを行う。引数`INPUT`が指定されていない場合は標準入力から入力を行う。`--merge`オプションが指定されていない場合は、保持している全エントリを削除し、入力されたデータへの置き換えを行う。

`--merge`オプションが指定された場合は、現在のエントリを保持したまま入力されたデータの追加を行う。追加時に同じIDのエントリが存在し、`--overwrite`オプションが指定されていない場合はエラーとなり処理を中断する（このときデータベースの状態はサブコマンド実行前の状態に戻される）。

`--overwrite`オプションが指定された場合、マージ時にIDが衝突するエントリが存在する場合エントリの上書を行う（上書を行った旨の警告表示は行われる）。

`--dry-run`は書き込みを行わずデータのチェックのみを行うモードで実行される(`--merge`オプションのときのみ意味をなす)。

``

----
## 非機能性要件

  * 登録件数50～200件程度の規模をターゲットとする
  * 対象ターゲットに於いて、体感できるような遅延が発生しないように構築すること

----
## 将来の拡張予定

  * `server`サブコマンドを追加しWebサーバ機能を実装予定。Web UIによるフロントエンドを提供する事を予定している。
