# パスワードマネージャ仕様

## 機能概要
個人向けパスワードマネージャとしての基本機能を持つ。CLIとして実装され、個別の機能を実現するためのサブコマンドを持つ。
登録されたエントリはデータベースに保存される。データベースはredbにより構築される。

----
## エントリの仕様
エントリのデータ構造をYAML形式のJSON Schemaで記述する。

```YAML
type: "object"
required:
  - id
  - aliases
  - tags
  - properties
  - last_update
properties:
  id:
    description: >-
      エントリのIDが文字列形式のULIDで格納される
    type: "string"

  service:
    description: >-
      エントリのサービス名が格納される。
    type: "string"
  
  aliases:
    description: >-
      エントリの別名(サービスの旧名など)のリストが格納される。
    type: "array"
    items: "string"
    minItems: 0

  tags:
    description: >-
      エントリに付与されたタグ文字列のリストが格納される
    type: "array"
    items: "string"
    minItems: 0

  properties:
    description: >-
      ユーザ名やパスワードなどエントリのプロパティ情報が格納される。プロパティ名
      の末尾に'!'を付与した場合、秘匿項目として扱われる。
    type: "object"
    minItems: 1

  last_update:
    descriptioin: >-
      エントリの最終更新日時が格納される。

  removed:
    description: >-
      エントリが削除されたことを表すフラグが格納される。このフィールドがtrueの場合はエントリが削除されていることを表す。
    type: "boolean"
```

----
## コマンドライン仕様
```sh
pwmgr [OPTIONS] <SUB-COMMAND> [COMMAND-OPTIONS]
```

### グローバルオプション
グローバルオプションとして以下の物を指定できる。

| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-c`, `--config PATH`   | デフォルト設定ファイルのパスを指定する | %LOCALAPPDATA%\pwmgr\config.toml (windows)<br>~/.config/pwmgr/config.toml (linux, macos)
| `-l`, `--log-level LEVEL` | ログレベルを指定する | "info"
| `-L`, `--log-output PATH` | ログの出力先を指定する | LOCALAPPDATA%\pwmgr\log\ (windows)<br>~/.local/share/pwmgr/log/ (linux, macos)  
| `-d`, `--db-path PATH`  | データベースファイルのパスを設定する   | %LOCALAPPDATA%\pwmgr\database.redb (windows)<br>~/.local/share/pwmgr/database.redb (linux, macos)
| `-e`, `--editor EDITOR` | 編集で使用するテキストエディタの名前を指定する | notepad (windows)<br>nano (linux, macos)
| `--json-output`         | 出力をJSON形式にする
| `--show-option`         | 設定内容(オプションの指定内容)を表示する
| `--save-default`        | config.tomlへのデフォルト値の書き込み指示
| `-h`, `--help`          | ヘルプメッセージの表示
| `-v`, `--version`       | プログラムのバージョン番号の表示

`--log-level`オプションの`<LEVEL>`には以下の値が設定可能。

  - off : ログを記録しない
  - error : エラーの場合のみを記録
  - warn : 警告以上の場合を記録
  - info : 一般情報レベルを記録
  - debug : デバッグ用メッセージも記録
  - trace : トレース情報も記録

`--log-output`にはログの出力先を指定できるが、ファイルのパスを指定した場合は単一ファイルへの出力となり、ディレクトリパスを指定した場合はログローテション付きで10本のファイルに自動切り替えを行いながら記録を行う(一本あたりのサイズ制限は2Mバイト)。

`--db-path`および`--editor`についてはconfig.tomlでデフォルト値を設定することができる。
また`--editor`については環境変数EDITORでも設定することができる。設定の優先度は コマンドラインオプション &gt; config.toml &gt; 環境変数となる。

----
### サブコマンド
以下のサブコマンドが使用できる。

  - query : エントリの表示 
  - search : サービスの検索
  - add : エントリの追加
  - edit : エントリの編集
  - remove : エントリの削除
  - list : 既存エントリの一覧表示
  - tags : 付与済みタグの一覧表示
  - export : バックアップ用YAMLの出力
  - import : バックアップ用YAMLの取り込み
  - sync : 他ホストとのデータベース同期

#### queryコマンド
エントリの検索・表示(一件のみ)。

##### コマンドライン
```sh
pwmgr [OPTIONS] query [COMMAND-OPTIONS] <KEY>
```
##### オプション
queryコマンドのオプションは以下の物が指定できる。

| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-f`, `--full` | 全ての項目を表示する    | 
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact
| `-M`, `--masked-mode` | 秘匿項目を表示しない | exact
| `-U`, `--unmasked-mode` | 秘匿項目を表示する | exact
| `-h`, `--help` | ヘルプメッセージの表示  |

##### 概要
引数KEYでサービスを検索し、該当するエントリの情報を標準出力に表示する。KEYは以下の項目を検索対象とする(番号は検索優先度)。

 1. エントリのID (完全一致)
 2. サービス名 (あいまい検索)
 3. 別名リスト (あいまい検索)

`--match-mode`でマッチモードを選択することができる。設定できるモードは以下の通り。

 - exact : 完全一致モード(但し大文字小文字は無視)
 - contains : 部分一致モード(大文字小文字は無視)
 - regex : 正規表現モード
 - fuzzy : 揺らぎモード

通常は以下の項目のみを表示する。

 - ID
 - サービス名
 - 全てのプロパティ(秘匿処理は行わない)

オプション`--full`が指定された場合はエントリとして定義されている全ての項目を表示する。
表示対象は最初に見つかった一件のみを出力する。

`--masked-mode`オプションで秘匿項目に設定されたプロパティの隠蔽して表示を行う(値を"***"に変換し表示する)。`--unmasked-mode`は秘匿項目もそのまま表示を行う。

----
#### searchコマンド

##### コマンドライン
```sh
pwmgr search [OPTIONS] <KEY>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-s`, `--service`   | サービス名を検索対象とするか否かを表すフラグ | 
| `-t`, `--tag <TAG>` | 検索対象とするタグ(複数指定可) | 
| `-p`, `--property <PROPERTY_NAME>` | 検索対象とするプロパティ(複数指定可) | 
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact
| `--sort-by <MODE>` | 検索結果のソートモード(`default`/`service_name`/`last_update`) |
| `-r`, `--reverse-sort` | ソートを逆順で行う |
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
引数KEYでサービスを検索しIDとサービス名のリストを標準出力に表示する。queryと異なり複数のエントリをリストアップする。`--property`オプションが指定されない場合は、サービス名と別名リストを検索の対象とする。

`--tag`オプションでタグを指定したときは、そのタグが付与されたエントリのみを検索対象として絞り込む。

`--property`オプションでプロパティ名を指定したときは、そのプロパティを検索対象とする(例えば特定の住所で登録されたエントリの検索などを想定)。

`--regex`オプションが指定された場合はKEYを正規表現と見なし、正規表現にマッチするエントリの検索を行う。

`--sort-by`で出力順を指定できる。`default`はID昇順、`service_name`はサービス名昇順、`last_update`は更新日時昇順（更新日時未設定は末尾）。`--reverse-sort`で順序を反転させる。

----
#### addコマンド

##### コマンドライン
```sh
pwmgr add [OPTIONS] [SERVICE-NAME]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
エントリの新規登録を行う。本コマンドが実行されると、エディタの起動を行いYAM形式のテンプレートをユーザに編集させる。引数SERVICE-NAMEが指定された場合は、その文字列がデフォルトのサービス名としてテンプレートに入力された状態で編集が開始される。

エディタで書き込み保存され、入力された内容がスキーマに一致する場合はその内容でエントリの登録を行う。

エディタで入力が行われなかった場合や、スキーマに一致しない内容だった場合はユーザに継続して編集するか否かを問いあわせ細雨編集を行うか否かを決定する(このとき内容をリセットするか否かも選択肢に入れる)。

編集用のテンプレートはエントリ定義用のYAMLのスケルトンを用いる。但し、サービスIDは事前に割り当てるので入力済みとする。

----
#### editコマンド

##### コマンドライン
```sh
pwmgr edit [OPTIONS] <ID>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
引数IDでサービスを検索し、該当するエントリの編集を行う。

エディタで書き込み保存され、入力された内容がスキーマに一致する場合はその内容でエントリの上書を行う。このとき、入力内容の表示を行い上書の確認を行う。

エディタで入力が行われなかった場合や、スキーマに一致しない内容だった場合はユーザに継続して編集するか否かを問いあわせ再編集を行うか否かを決定する(このとき内容をリセットするか否かも選択肢に入れる)。

----
#### removeコマンド

##### コマンドライン
```sh
pwmgr remove [OPTIONS] <ID>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `--hard`            | データベースからの削除を行う(ハードリムーブ)
| `-h`, `--help`      | ヘルプメッセージの表示  |

##### 概要
エントリの削除を行う。`--hard`オプションが指定されていない場合は、復活可能なソフトリムーブを行う。ソフトリムーブはエントリにremovedをマークすることにより行う(エントリの復活はeditコマンドで編集し、removedを削除することにより行う)。ソフトリムーブ状態ではquery,list,search,exportの対象外とする。但し、listコマンドには削除済みエントリも含めて表示させるオプションを設け、このオプション指定時は削除されたエントリも一覧表示に含める。

`--hard`オプションが指定された場合は復活不可能なハードリムーブを行う。ソフトリムーブと異なりこちらはデータベースからの削除を行う。

----
#### listコマンド

##### コマンドライン
```sh
pwmgr list [OPTIONS]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-t`, `--tag <TAG>` | リストアップ対象タグ(複数指定可) |
| `--sort-by <MODE>` | エントリの表示順をソートする(`default`/`service_name`/`last_update`) |
| `-r`, `--reverse-sort` | ソートを逆順で行う | 
| `--with-removed` | 削除済みエントリも一覧に含める |
| `-h`, `--help`      | ヘルプメッセージの表示  |


##### 概要
登録されているサービスの一覧を標準出力に出力する。出力はIDとサービス名の組をリスティングする(ID順で出力する)。`--tag`が指定されていない場合は登録されているエントリ全てがリスティング対象となる。

`--tag`でタグ名が指定された場合は、そのタグの一覧を出力する。複数`--tag`オプションが指定された場合は指定されたタグ全てが出力対象となる。

`--with-removed`を指定した場合は、削除済みエントリも含めて表示を行う。この場合、削除済みエントリのID末尾には'!'を付与し削除済みエントリであることを表す。

`--sort-by`で出力順を指定できる。`default`はID昇順、`service_name`はサービス名昇順、`last_update`は更新日時昇順（更新日時未設定は末尾）。`--reverse-sort`で順序を反転させる。

----
#### tagsコマンド

##### コマンドライン
```sh
pwmgr tags [OPTIONS] [KEY]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-m`, `--match-mode <MODE>` | 検索時のマッチモードの選択 | exact 
| `-n`, `--number`  | 登録件数表示モード | 
| `--sort-by <MODE>` | ソートモード(`default`/`number_of_regist`) |
| `-r`, `--reverse-sort` | ソートを逆順で行う | 
| `-h`, `--help`    | ヘルプメッセージの表示  |


##### 概要
付与されているタグの一覧を表示する。`KEY`を指定した場合はキーワードに基づいた絞り込みを行う。オプションが何も指定されない場合はタグを文字列を昇順にソートして表示する。

`--match-mode`でマッチモードを選択することができる。設定できるモードは以下の通り。

 - exact : 完全一致モード(但し大文字小文字は無視)
 - contains : 部分一致モード(大文字小文字は無視)
 - regex : 正規表現モード
 - fuzzy : 揺らぎモード

`--number`でタグ毎の登録件数の表示を行う事ができる。

`--sort-by`で出力順を指定できる。`default`はタグ名昇順、`number_of_regist`は件数降順（件数同一時はタグ名昇順）。`--reverse-sort`で順序を反転させる。

タグが全く登録されていない場合は「付与されたタグはありません」と表示しエラーとして扱う。

----
#### exportコマンド

##### コマンドライン
```sh
pwmgr export [OPTIONS]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-o`, `--output <PATH>` | 出力先のファイルのパス | 
| `-h`, `--help`          | ヘルプメッセージの表示  |

##### 概要
バックアップ若しくはデータ移行用のYAMLファイルを出力する。`--output`オプションが指定されていない場合は標準出力へ出力する。現バージョンでは平文による出力を行う。

`--output`オプションが指定されている場合、オプションで指定されたファイルへの出力を行う。

----
#### importコマンド

##### コマンドライン
```sh
pwmgr import [OPTIONS] [INPUT]
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-m`, `--merge`        | マージを行うか否かのフラグ | 
| `-O`, `--overwrite`    | オーバーライトを行うか否かのフラグ |
| `--dry-run`            | Dru-Runフラグ | 
| `-h`, `--help`          | ヘルプメッセージの表示  |

##### 概要
`export`サブコマンドで出力されたYAMLファイルの取り込みを行う。引数`INPUT`が指定されていない場合は標準入力から入力を行う。`--merge`オプションが指定されていない場合は、保持している全エントリを削除し、入力されたデータへの置き換えを行う。

`--merge`オプションが指定された場合は、現在のエントリを保持したまま入力されたデータの追加を行う。追加時に同じIDのエントリが存在し、`--overwrite`オプションが指定されていない場合はエラーとなり処理を中断する（このときデータベースの状態はサブコマンド実行前の状態に戻される）。

`--overwrite`オプションが指定された場合、マージ時にIDが衝突するエントリが存在する場合エントリの上書を行う（上書を行った旨の警告表示は行われる）。このとき、エントリの更新日時を比較し新しいエントリの方が残存するようにする。

`--dry-run`は書き込みを行わずデータのチェックのみを行うモードで実行される(`--merge`オプションのときのみ意味をなす)。


----
#### syncコマンド

##### コマンドライン
```sh
pwmgr sync --server [BIND-ADDR][:PORT]
pwmgr sync --client <CONNECT-ADDR[:PORT]>
```

##### オプション
| オプション | 意味 | デフォルト値
|:--|:--|:--
| `-s`, `--server`        | サーバモードで起動 | 
| `-c`, `--client`    | クライアントモードで起動 |
| `-h`, `--help`          | ヘルプメッセージの表示  |

##### 概要
`--server`オプションを指定して起動した場合は`BIND-ADDR`で待ち受けを行う。`BIND-ADDR`を省略した場合はANY-ADDRに対して待ち受けを行う。`:PORT`で待ち受けポートを指定することも出来る（指定しない場合はポート2456で待ち受けを行う）。

`--client`オプションを指定して起動した場合は`CONNECT-ADDR`に対して接続を行う（接続先アドレスは省略できない）。`:PORT`で接続先のポート番号を変更することができる（指定しない場合はポート2456に接続を行う）。

サーバとクライアントの接続が行われると、`DESIGN.md`で記述されたプロトコルにより同期処理が行われ、正常に完了すると双方のデータベース内容が同じになる。

----
## ファイル要件
本ツールで使用するファイルのデフォルトパスはXDG標準に準拠させる。本ツールでは以下のファイルを使用する。

 - コンフィギュレーションファイル
 - データベースファイル

### コンフィギュレーションファイル
各種オプション(サブコマンドのオプションを含む)のデフォルト値が定義できる設定ファイル(toml形式)が置かれる。デフォルトパスは`$XDG_CONFIG_HOME/config.toml`とする (グローバルオプションの `--config`で変更可能)。オプション類のデフォルト値を記述する。

コンフィギュレーションファイルには以下のサブコマンドに対応したテーブルを設ける。

 - `global`
 - `query` 
 - `search`
 - `list`
 - `tags`

いずれのテーブルも省略可能で、省略した場合はデフォルト値が適用される。

#### globalテーブル
グローバルオプションに対するデフォルト値を定義し以下のキーを定義する。

| キー | 設定内容 | 対応オプション |デフォルト値
|:--|:--|:--
| `log_level` | ログレベル | `--log-level` | "info"
| `log_output` | ログの出力先 | `--log-output` | `$XDG_DATA_HOME/log`
| `db_path` | データベースファイルのパス | `--db-path` | `$XDG_DATA_HOME/database.redb`
| `editor`  | 使用するエディタの名称     | `--editor`  | OSによって異なる

使用するエディタの名称はOSによって以下の様に切り替える。

| OS | エディタ名
|:--|:--
| Windows | notepad
| Linux | nano
| MacOS | nano

#### queryテーブル
`query`サブコマンドのオプションに対するデフォルト値を定義し以下のキーを定義する。

| キー | 設定内容 | 対応オプション | デフォルト値
|:--|:--|:--
| `match_mode` | 検索時のマッチモード | `--match-mode` | "contains"
| `masked_mode` | 秘匿項目の隠蔽を行うか否か | `--match-mode` | false

masked_modeは、オプション指定で`--masked-mode`と`--unmasked-mode`の両方が未指定の場合参照する。

#### searchテーブル
`search`サブコマンドのオプションに対するデフォルト値を定義し以下のキーを定義する。

| キー | 設定内容 | 対応オプション | デフォルト値
|:--|:--|:--
| `with_service_name` | 検索対象にサービス名を含めるか否か | `--service` | false
| `match_mode` | 検索時のマッチモード | `--match-mode` | contains
| `target_properties` | 検索対象とするプロパティの名前のリスト | `--properties` | 空のVec<String>
| `sort_mode` | ソート指示 | `--sort-by` | "default"
| `reverse_sort` | ソート順序を逆順にするか否か | `--reverse-sort` | false

`sort_mode`に指定できる値は以下の何れかとする。

 - "default" : デフォルト(エントリIDでソート) 
 - "service_name" : サービス名でソート
 - "last_update" : 更新日時でソート

#### listテーブル
`list`サブコマンドのオプションに対するデフォルト値を定義し以下のキーを定義する。

| キー | 設定内容 | 対応オプション | デフォルト値
|:--|:--|:--
| `tag_and` | 複数タグ指定時にAND評価を行うか否か | `--tag-and` | false
| `sort_mode` | ソート指示 | `--sort-by` | "default"
| `reverse_sort` | ソート順序を逆順にするか否か | `--reverse-sort` | false
| `with_removed` | 削除済みエントリも表示するか否か | `--with-removed` | false

`sort_mode`に指定できる値は以下の何れかとする。

 - "default" : デフォルト(エントリIDでソート) 
 - "service_name" : サービス名でソート
 - "last_update" : 更新日時でソート

#### tagsテーブル
`tags`サブコマンドのオプションに対するデフォルト値を定義し以下のキーを定義する。

| キー | 設定内容 | 対応オプション | デフォルト値
|:--|:--|:--
| `with_number` | 付与件数も表示するか否か | `--number` | false
| `sort_mode` | ソート指示 | `--sort-by` | "default"
| `reverse_sort` | ソート順序を逆順にするか否か | `--reverse-sort` | false

`sort_mode`に指定できる値は以下の何れかとする。

 - "default" : デフォルト(タグ名でソート) 
 - "number_of_regist" : 登録件数でソート

### データベースファイル
redbのデータベースファイルが置かれる。デフォルトパスは$XDG_DATA_HOME/database.redbとする (グローバルオプションの `--db-path`かconfig.tomlの`global.db_path`で変更可能)。

----
## 非機能性要件

  * 登録件数50～200件程度の規模をターゲットとする
  * 対象ターゲットに於いて、体感できるような遅延が発生しないように構築すること

----
## 将来の拡張予定

  * `server`サブコマンドを追加しWebサーバ機能を実装予定。Web UIによるフロントエンドを提供する事を予定している。
